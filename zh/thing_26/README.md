# 不要忽视错误！

> *一天晚上，我走在街上，准备去酒吧见一些朋友。我们有一段时间没有一起喝啤酒了，我期待着再次见到他们。匆忙中，我没有注意脚下的路。我被路边的路缘绊倒，脸朝下摔倒在地。好吧，我想这是我注意力不集中的报应。*

> *我的腿受伤了，但我急着去见朋友。所以我爬起来继续走。随着我走得更远，疼痛越来越严重。虽然我一开始以为这只是惊吓，但我很快意识到有些不对劲。*

> *尽管如此，我还是匆匆赶到了酒吧。到达时，我已经痛苦不堪。那晚我过得并不愉快，因为我被疼痛分散了注意力。第二天早上我去看了医生，发现我的胫骨骨折了。如果我在感到疼痛时停下来，我就不会因为继续行走而造成更多的伤害。这可能是我人生中最糟糕的“宿醉”了。*

太多程序员编写的代码就像我那灾难性的夜晚一样。

*错误，什么错误？不会很严重的。真的。我可以忽略它。* 这并不是编写健壮代码的好策略。事实上，这只是纯粹的懒惰（错误的那种）。无论你认为代码中出现错误的可能性有多小，你都应该始终检查并处理它。每一次都是如此。如果你不这样做，你并不是在节省时间：你是在为未来积累潜在的问题。

我们在代码中报告错误的方式有多种，包括：

- **返回码** 可以用作函数的返回值，表示“它没有成功”。错误返回码太容易被忽略了。你在代码中看不到任何突出显示问题的内容。事实上，忽略一些标准C函数的返回值已经成为标准做法。你有多经常检查`printf`的返回值？

- **errno** 是C语言中一个奇怪的异常，它是一个单独的全局变量，用于表示错误。它容易被忽略，难以使用，并导致各种棘手的问题——例如，当你有多个线程调用同一个函数时会发生什么？有些平台在这里为你屏蔽了痛苦；而有些则没有。

- **异常** 是一种更结构化、语言支持的错误信号和处理方式。你不可能忽略它们。或者你能吗？我见过很多这样的代码：

```
try {
    // ...做点什么...
}
catch (...) {} // 忽略错误
```

这种糟糕的构造的唯一优点是，它突显了你正在做一些道德上可疑的事情。

如果你忽视错误，视而不见，假装什么都没出错，你将面临巨大的风险。就像我的腿最终比如果我立即停止行走时更糟糕一样，不管不顾地继续前进可能导致非常复杂的故障。尽早处理问题。保持简洁。

不处理错误会导致：

- **脆弱的代码。** 充满令人兴奋、难以发现的错误的代码。
- **不安全的代码。** 黑客经常利用糟糕的错误处理来入侵软件系统。
- **糟糕的结构。** 如果你的代码中有错误，而这些错误需要不断处理，那么你可能有一个糟糕的接口。表达它，使错误不那么具有侵入性，处理起来也不那么繁琐。

正如你应该检查代码中的所有潜在错误一样，你需要在接口中暴露所有可能的错误条件。不要隐藏它们，假装你的服务总是能正常工作。

为什么我们不检查错误？有一些常见的借口。你同意哪些？你会如何反驳每一个？

- 错误处理会扰乱代码的流程，使其更难阅读，更难发现“正常”的执行流程。
- 这是额外的工作，而我的截止日期迫在眉睫。
- 我知道这个函数调用**永远不会**返回错误（`printf`总是有效，`malloc`总是返回新内存——如果它失败了，我们有更大的问题……）。
- 这只是一个玩具程序，不需要编写到生产级别。

作者：[Pete Goodliffe](http://programmer.97things.oreilly.com/wiki/index.php/Pete_Goodliffe)