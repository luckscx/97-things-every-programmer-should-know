#在国家中思考

现实世界中的人们与国家有着一种奇怪的关系。今天早上，我在当地的一家商店停了下来，为另一天将咖啡因转化为代码做准备。因为我最喜欢的方式是喝拿铁咖啡，而且我找不到牛奶，所以我问了店员。

“对不起，我们的牛奶已经卖光了。”

对于程序员来说，这是一种奇怪的说法。你要么没有牛奶，要么没有。当牛奶用完的时候，没有刻度。也许她是想告诉我，他们会有一周没有牛奶了，但结果是一样的--对我来说是浓缩咖啡的一天。

在大多数现实世界的情况下，人们对国家的放松态度并不是问题。然而，不幸的是，许多程序员对状态也相当含糊--这是一个问题。

假设有一个简单的Webshop，它只接受信用卡，不向客户开票，其中的`Order`类包含以下方法：

```
公共布尔值isComplete(){
返回isPaid()&&hasShipping()；
}
```

合情合理，对吧？那么，即使表达式被很好地提取到一个方法中，而不是复制‘n’粘贴到任何地方，该表达式也不应该存在。事实是，它确实突显了一个问题。为什么？因为订单在付款前不能发货。因此，除非`isPaid`为TRUE，否则`hasShiped`不可能为TRUE，这使得该表达式的一部分是冗余的。您可能仍然需要`isComplete`以使代码清晰，但它应该如下所示：

```
公共布尔值isComplete(){
返回已发货()；
}
```

在我的工作中，我总是看到遗漏支票和多余支票。这个示例很小，但是当您添加取消和偿还时，它将变得更加复杂，并且对良好状态处理的需求增加。在这种情况下，订单只能处于以下三种不同状态之一：

-*正在进行：*可以添加或删除项目。不能装船。
-*已付费：*不能添加或移除项目。可以装运。
-*已发货：*完成。不接受更多更改。

这些状态很重要，您需要在执行操作之前检查您是否处于预期状态，以及您是否只从您所在的位置移动到合法状态。简而言之，你必须在正确的地方小心地保护你的物品。

但在美国，你是如何开始思考的呢？将表达式提取为有意义的方法是一个很好的开始，但这只是一个开始。基础是理解状态机。我知道你在CS课上可能会有不好的回忆，但把它们留下来吧。状态机并不是特别难。将它们形象化，使它们简单易懂，易于谈论。测试您的代码以分解有效和无效的状态和转换，并保持它们的正确性。研究国家模式。当你感觉舒服的时候，阅读《契约式设计》。它通过在每个公共方法的进入和退出时验证传入数据和对象本身来帮助您确保有效状态。

如果您的状态不正确，则存在错误，如果您不中止，则可能会损坏数据。如果您发现状态检查有噪音，学习如何使用工具、代码生成、编织或方面来隐藏它们。无论您选择哪种方法，状态思维都会使您的代码更简单、更健壮。

作者：Niclas Nilsson](http://programmer.97things.oreilly.com/wiki/index.php/Niclas_Nilsson)