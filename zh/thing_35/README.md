# API设计的黄金法则

API设计是困难的，尤其是在大规模设计中。如果你正在设计一个将拥有数百或数千用户的API，你必须考虑未来如何更改它，以及你的更改是否会破坏客户端代码。除此之外，你还必须考虑API用户对你的影响。如果你的API类在内部使用了它自己的某个方法，你必须记住用户可能会继承你的类并重写该方法，这可能是灾难性的。你将无法更改该方法，因为一些用户已经赋予了它不同的含义。你未来的内部实现选择将受制于你的用户。

API开发者以各种方式解决这个问题，但最简单的方法是锁定API。如果你使用Java，你可能会倾向于将大多数类和方法设为`final`。在C#中，你可能会将类和方法设为`sealed`。无论你使用哪种语言，你可能会倾向于通过单例模式或使用静态工厂方法来呈现你的API，以防止有人重写行为并以可能限制你未来选择的方式使用你的代码。这一切似乎都是合理的，但真的是这样吗？

在过去十年中，我们逐渐意识到单元测试是实践中极其重要的一部分，但这一教训尚未完全渗透到整个行业。证据随处可见。随便拿一个使用第三方API的未经测试的类，尝试为其编写单元测试。大多数时候，你会遇到麻烦。你会发现使用API的代码像胶水一样粘在API上。没有办法模拟API类，以便你可以感知代码与它们的交互，或者为测试提供返回值。

随着时间的推移，这种情况会有所改善，但前提是我们在设计API时开始将测试视为一个真正的用例。不幸的是，这比仅仅测试我们的代码要复杂一些。这就是**API设计的黄金法则**的用武之地：*仅仅为你开发的API编写测试是不够的；你必须为使用你API的代码编写单元测试。当你这样做时，你会亲身体验到用户在他们尝试独立测试代码时必须克服的障碍。*

没有一种方法可以让开发者轻松测试使用你API的代码。`static`、`final`和`sealed`并不是天生不好的结构。它们有时是有用的。但重要的是要意识到测试问题，要做到这一点，你必须亲身体验它。一旦你体验过，你就可以像处理其他设计挑战一样来处理它。

作者：[Michael Feathers](http://programmer.97things.oreilly.com/wiki/index.php/Michael_Feathers)