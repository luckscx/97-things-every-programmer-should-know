#理性编码

尝试手动推理软件正确性会导致正式证明比代码更长，而且比代码更有可能包含错误。自动化工具更可取，但并不总是可行的。下面描述的是一条中间路线：关于正确性的半形式化推理。

基本的方法是将考虑中的所有代码分成几个小部分-从单行(如函数调用)到不到十行的块-并讨论它们的正确性。这些论点只需要足够强大，就可以说服你的魔鬼倡导者同行程序员。

应该选择一个段，以便在每个端点处程序的*状态*(即，程序计数器和所有“活的”对象的值)满足易于描述的属性，并且该段的功能(状态转换)很容易被描述为单个任务--这些将使推理变得更简单。这种端点属性概括了函数的“前置条件”和“后置条件”，以及循环和类(相对于它们的实例)的“不变变量”等概念。争取各节之间尽可能地相互独立可以简化推理，并且在修改这些节时是必不可少的。

许多众所周知的编码实践(尽管可能不那么容易遵循)和被认为是“好的”的编码实践使推理变得更容易。因此，只要打算对代码进行推理，您就已经开始考虑更好的样式和结构。不出所料，这些实践中的大多数都可以由静态代码分析器进行检查：

-避免使用GOTO语句，因为它们会使远程部分高度相互依赖。
-避免使用可修改的全局变量，因为它们使使用它们的所有节都是从属的。
-每个变量应具有尽可能小的作用域。例如，局部对象可以在第一次使用之前声明。
-只要相关，就使对象*不可更改*。
-使用水平和垂直间距使代码可读。例如，对齐相关结构并使用空行分隔两个部分。
-通过为对象、类型、函数等选择描述性(但相对较短)名称，使代码具有自我文档化。
-如果需要嵌套节，请将其作为函数。
-使你的职能简短，专注于一项任务。旧的*24行限制*仍然适用。尽管屏幕尺寸和分辨率发生了变化，但自20世纪60年代以来，人类的认知没有任何变化。
-函数应该有很少的参数(四个参数是一个很好的上限)。这不会限制传递给函数的数据：将相关参数分组到单个对象中将受益于*对象不变量*，并节省了推理，例如它们的连贯性和一致性。
-更一般地，每个代码单元，从块到库，都应该有一个*狭窄的接口*。较少的交流减少了所需的推理。这意味着返回内部状态的*getter*是一种负担--不要向对象请求要使用的信息。相反，要求对象使用其已有的信息来完成工作。换句话说，“封装”是关于“窄接口”的。
-为了保留类*不变量*，应该不鼓励使用*setters*，因为*setters*往往允许破坏控制对象状态的不变量。

除了对其正确性进行推理外，对您的代码进行辩论也可以帮助您理解它。为了每个人的利益，交流你所获得的见解。

作者：Yechiel Kimchi](http://programmer.97things.oreilly.com/wiki/index.php/Yechiel_Kimchi)
